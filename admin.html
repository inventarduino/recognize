<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - CryptoEduca</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input, button {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background-color: #2980b9;
        }
        .hidden {
            display: none;
        }
        .error {
            color: #e74c3c;
        }
        .success {
            color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CryptoEduca - Panel de Profesor</h1>
        
        <!-- Sección de Login -->
        <div id="loginSection" class="section">
            <h2>Iniciar Sesión</h2>
            <div>
                <label for="rutProfesor">RUT Profesor:</label>
                <input type="text" id="rutProfesor" placeholder="12345678-9">
            </div>
            <div>
                <label for="claveProfesor">Contraseña:</label>
                <input type="password" id="claveProfesor">
            </div>
            <button id="btnLogin">Ingresar</button>
            <p id="loginMessage" class="error"></p>
        </div>
        
        <!-- Sección de Profesor -->
        <div id="profesorSection" class="section hidden">
            <h2>Bienvenido, <span id="nombreProfesor"></span></h2>
            <p>Tu saldo actual: <span id="saldoProfesor"></span> monedas</p>
            
            <h3>Consultar saldo de estudiante</h3>
            <div>
                <label for="rutEstudianteConsulta">RUT Estudiante:</label>
                <input type="text" id="rutEstudianteConsulta" placeholder="12345678-9">
                <button id="btnConsultarEstudiante">Consultar</button>
            </div>
            <p id="saldoEstudianteConsulta"></p>
            
            <h3>Transferir monedas a estudiante</h3>
            <div>
                <label for="rutEstudianteTransferencia">RUT Estudiante:</label>
                <input type="text" id="rutEstudianteTransferencia" placeholder="12345678-9">
            </div>
            <div>
                <label for="montoTransferencia">Monto:</label>
                <input type="number" id="montoTransferencia" min="1">
            </div>
            <button id="btnTransferir">Transferir</button>
            <p id="transferenciaMessage"></p>
            
            <button id="btnLogout">Cerrar Sesión</button>
        </div>
    </div>

    <script>
        // Elementos del DOM
        const loginSection = document.getElementById('loginSection');
        const profesorSection = document.getElementById('profesorSection');
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const btnConsultarEstudiante = document.getElementById('btnConsultarEstudiante');
        const btnTransferir = document.getElementById('btnTransferir');
        const loginMessage = document.getElementById('loginMessage');
        const transferenciaMessage = document.getElementById('transferenciaMessage');
        
        // Variables de estado
        let profesorActual = null;
        let listaprof = [];
        let listaestu = [];
        
        // Cargar archivos al iniciar
        async function cargarArchivos() {
            try {
                const responseProf = await fetch('listaprof.txt');
                const textProf = await responseProf.text();
                listaprof = parsearArchivo(textProf);
                
                const responseEstu = await fetch('listaestu.txt');
                const textEstu = await responseEstu.text();
                listaestu = parsearArchivo(textEstu);
            } catch (error) {
                console.error('Error cargando archivos:', error);
            }
        }
        
        // Parsear archivo de texto a array de objetos
        function parsearArchivo(texto) {
            return texto.split('\n')
                .filter(linea => linea.trim() !== '')
                .map(linea => {
                    const partes = linea.split(' -> ');
                    const saldo = partes[3] ? parseFloat(partes[3].replace(/\./g, '').replace(',', '.')) : 0;
                    return {
                        rut: partes[0].trim(),
                        nombre: partes[1].trim(),
                        clave: partes[2].trim(),
                        saldo: saldo
                    };
                });
        }
        
        // Convertir array de objetos a texto para guardar
        function serializarDatos(datos) {
            return datos.map(item => 
                `${item.rut} -> ${item.nombre} -> ${item.clave} -> ${item.saldo.toLocaleString('es-CL')}`
            ).join('\n');
        }
        
        // Guardar cambios en los archivos (simulado para GitHub Pages)
        async function guardarCambios() {
            // En un entorno real, aquí harías una petición a un servidor para guardar los cambios
            // Como esto es para GitHub Pages, solo actualizamos los arrays en memoria
            console.log('Cambios guardados (simulado para GitHub Pages)');
            console.log('Profesores:', listaprof);
            console.log('Estudiantes:', listaestu);
            
            // En un entorno real, usarías algo como:
            // await fetch('guardar.php', { method: 'POST', body: ... });
        }
        
        // Iniciar sesión
        btnLogin.addEventListener('click', async () => {
            const rut = document.getElementById('rutProfesor').value.trim();
            const clave = document.getElementById('claveProfesor').value.trim();
            
            if (!rut || !clave) {
                loginMessage.textContent = 'Por favor ingresa RUT y contraseña';
                return;
            }
            
            await cargarArchivos();
            
            const profesor = listaprof.find(p => p.rut === rut);
            
            if (!profesor) {
                loginMessage.textContent = 'RUT no encontrado';
                return;
            }
            
            if (profesor.clave !== clave) {
                loginMessage.textContent = 'Contraseña incorrecta';
                return;
            }
            
            profesorActual = profesor;
            document.getElementById('nombreProfesor').textContent = profesor.nombre;
            document.getElementById('saldoProfesor').textContent = profesor.saldo.toLocaleString('es-CL');
            
            loginSection.classList.add('hidden');
            profesorSection.classList.remove('hidden');
            loginMessage.textContent = '';
        });
        
        // Cerrar sesión
        btnLogout.addEventListener('click', () => {
            profesorActual = null;
            profesorSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            document.getElementById('rutProfesor').value = '';
            document.getElementById('claveProfesor').value = '';
            document.getElementById('rutEstudianteConsulta').value = '';
            document.getElementById('saldoEstudianteConsulta').textContent = '';
            document.getElementById('rutEstudianteTransferencia').value = '';
            document.getElementById('montoTransferencia').value = '';
            transferenciaMessage.textContent = '';
        });
        
        // Consultar saldo de estudiante
        btnConsultarEstudiante.addEventListener('click', async () => {
            const rutEstudiante = document.getElementById('rutEstudianteConsulta').value.trim();
            
            if (!rutEstudiante) {
                document.getElementById('saldoEstudianteConsulta').textContent = 'Ingresa un RUT';
                document.getElementById('saldoEstudianteConsulta').className = 'error';
                return;
            }
            
            await cargarArchivos();
            
            const estudiante = listaestu.find(e => e.rut === rutEstudiante);
            
            if (!estudiante) {
                document.getElementById('saldoEstudianteConsulta').textContent = 'Estudiante no encontrado';
                document.getElementById('saldoEstudianteConsulta').className = 'error';
                return;
            }
            
            document.getElementById('saldoEstudianteConsulta').textContent = 
                `Saldo de ${estudiante.nombre}: ${estudiante.saldo.toLocaleString('es-CL')} monedas`;
            document.getElementById('saldoEstudianteConsulta').className = 'success';
        });
        
        // Transferir monedas
        btnTransferir.addEventListener('click', async () => {
            const rutEstudiante = document.getElementById('rutEstudianteTransferencia').value.trim();
            const monto = parseFloat(document.getElementById('montoTransferencia').value);
            
            if (!rutEstudiante || isNaN(monto) || monto <= 0) {
                transferenciaMessage.textContent = 'Datos inválidos';
                transferenciaMessage.className = 'error';
                return;
            }
            
            await cargarArchivos();
            
            // Buscar estudiante
            const estudianteIndex = listaestu.findIndex(e => e.rut === rutEstudiante);
            if (estudianteIndex === -1) {
                transferenciaMessage.textContent = 'Estudiante no encontrado';
                transferenciaMessage.className = 'error';
                return;
            }
            
            // Verificar saldo del profesor
            const profesorIndex = listaprof.findIndex(p => p.rut === profesorActual.rut);
            if (listaprof[profesorIndex].saldo < monto) {
                transferenciaMessage.textContent = 'Saldo insuficiente';
                transferenciaMessage.className = 'error';
                return;
            }
            
            // Realizar transferencia
            listaprof[profesorIndex].saldo -= monto;
            listaestu[estudianteIndex].saldo += monto;
            
            // Actualizar profesor actual
            profesorActual = listaprof[profesorIndex];
            document.getElementById('saldoProfesor').textContent = profesorActual.saldo.toLocaleString('es-CL');
            
            // Guardar cambios
            await guardarCambios();
            
            transferenciaMessage.textContent = 
                `Transferencia exitosa: ${monto.toLocaleString('es-CL')} monedas a ${listaestu[estudianteIndex].nombre}`;
            transferenciaMessage.className = 'success';
            
            // Limpiar campos
            document.getElementById('rutEstudianteTransferencia').value = '';
            document.getElementById('montoTransferencia').value = '';
        });
        
        // Cargar archivos al iniciar la página
        cargarArchivos();
    </script>
</body>
</html>
